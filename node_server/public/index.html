<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>Echo Speaks</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.5.9/css/mdb.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css" rel="stylesheet">
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.13.0/umd/popper.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"></script>
    <style>
        form div {
            margin-bottom: 0.5em;
            margin: 0 auto;
        }
        
        button.btn.btn-info.btn-block.my-4 {
            max-width: 200px;
            text-align: center;
        }
        
        .btn-rounded {
            border-radius: 50px!important;
        }
        
        form div label,
        form div input {
            display: block;
            margin-bottom: 0.3em;
        }
    </style>
</head>

<body>
    <!-- Settings Form -->
    <div style="margin: 0 auto; max-width: 500px;">
        <form class="p-5">
            <p class="h4 mb-0 text-center">Echo Speaks Configuration</p>
            <p id="scriptVer" class="h5 mt-0 mb-4 text-center"></p>
            <div class="card w-100 mb-3">
                <div class="card-header deep-orange lighten-1 white-text w-100 text-center">Amazon Login</div>
                <div id="loginInputDiv" class="card-body w-100">
                    <div class="md-form mt-0">
                        <i class="fa fa-user prefix"></i>
                        <input type="email" id="user" name="user" class="form-control" aria-describedby="emailHelpBlockMD">
                        <label for="user" data-error="wrong" data-success="right">Email</label>
                        <small id="emailHelpBlockMD" style="font-size: xx-small" class="form-text text-muted">
                            Enter your Amazon login email.
                        </small>
                    </div>
                    <div class="md-form">
                        <i class="fa fa-lock prefix"></i>
                        <input type="password" id="password" name="password" class="form-control" aria-describedby="passwordHelpBlockMD">
                        <label for="password" data-error="wrong" data-success="right">Password</label>
                        <small id="passwordHelpBlockMD" style="font-size: xx-small" class="form-text text-muted">
                            No password requirements defined.
                        </small>
                    </div>
                </div>
                <div id="clearLoginDiv" class="w-100">
                    <div class="text-center">
                        <h5 class="my-2">Authentication Good!</h5>
                        <button id="clearLoginBtn" class="btn btn-amber btn-rounded mt-0 mb-4" type="button"><i class="fa fa-close mr-1"></i>Clear Login Info</button>
                    </div>
                </div>
                <div id="proxyLoginDiv" class="w-100">
                    <div class="text-center">
                        <button id="proxyLoginLink" class="btn btn-info btn-rounded my-4" type="button"><i class="fa fa-unlock-alt mr-1"></i>Goto Login Page</button>
                    </div>
                </div>
            </div>

            <!-- Material input -->
            <div class="card w-100 mb-3">
                <div class="card-header gray lighten-1 w-100 text-center">Other Settings</div>
                <div class="card-body w-100">
                    <div class="md-form mt-0">
                        <i class="fa fa-at prefix"></i>
                        <input type="text" id="url" name="url" class="form-control" aria-describedby="urlHelpBlockMD">
                        <label for="url" data-error="wrong" data-success="right">Amazon Login domain</label>
                        <small id="urlHelpBlockMD" style="font-size: xx-small" class="form-text text-muted">
                            Enter the Alexa URL for login `amazon.com, amazon.de, etc.`
                        </small>
                    </div>
                    <div class="md-form">
                        <i class="fa fa-microchip prefix"></i>
                        <input type="text" id="smartThingsHubIP" name="smartThingsHubIP" class="form-control" aria-describedby="smartThingsHubIPHelpBlockMD">
                        <label for="smartThingsHubIP" data-error="wrong" data-success="right">SmartThings Hub IP</label>
                        <small id="smartThingsHubIPHelpBlockMD" style="font-size: xx-small" class="form-text text-muted">
                            Enter the IP Address xxx.xxx.xxx.xxx
                        </small>
                    </div>
                    <div class="md-form mt-0">
                        <i class="fa fa-info prefix"></i>
                        <input type="text" id="serverPort" name="serverPort" class="form-control" aria-describedby="serverPortHelpBlockMD">
                        <label for="serverPort" data-error="wrong" data-success="right">Server Port</label>
                        <small id="serverPortHelpBlockMD" style="font-size: xx-small" class="form-text text-muted">
                            Enter the port for the Echo Speaks Server.  Default: 8091
                        </small>
                    </div>
                    <div class="md-form mt-0">
                        <i class="fa fa-info prefix"></i>
                        <input type="text" id="proxyPort" name="proxyPort" class="form-control" aria-describedby="proxyPortHelpBlockMD">
                        <label for="proxyPort" data-error="wrong" data-success="right">Login Proxy Port</label>
                        <small id="proxyPortHelpBlockMD" style="font-size: xx-small" class="form-text text-muted">
                            Enter the port for the Echo Speaks Login Proxy. Default: 8092
                        </small>
                    </div>
                    <div class="md-form mb-0">
                        <i class="fa fa-refresh prefix"></i>
                        <input type="number" id="refreshSeconds" name="refreshSeconds" class="form-control" aria-describedby="refreshSecondsHelpBlockMD">
                        <label for="refreshSeconds" data-error="wrong" data-success="right">Device Data Refresh (Seconds)</label>
                        <small id="refreshSecondsHelpBlockMD" style="font-size: xx-small" class="form-text text-muted">
                            Enter a number between 5-3600
                        </small>
                    </div>
                </div>
            </div>

            <!-- Sign in button -->
            <div class="text-center">
                <button class="btn btn-success btn-rounded my-4" type="submit"><i class="fa fa-save mr-1"></i>Save Settings</button>
            </div>
        </form>
    </div>
    <!-- MDB core JavaScript -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.5.9/js/mdb.min.js"></script>
    <!-- Settings Form -->
    <script>
        // Get Root Page URL for Callback to Send Settings
        let rootOrigin = window.location.origin;
        let rootHost = window.location.hostname;
        console.log('rootOrigin: ' + rootOrigin);
        console.log('rootHost: ' + rootHost);

        $('#proxyLoginDiv').hide();
        $('#loginInputDiv').show();
        $('#clearLoginDiv').hide();
        var configData = {};
        $(document).ready(function() {
            let url = rootOrigin + '/configData';
            $.getJSON(url, function(data) {
                // console.log('configData: ', data);
                configData = data;
                $.each(data.state, function(key, val) {
                    if (key === 'loginProxyActive' && val === true) {
                        $('#loginInputDiv').hide();
                        $('#proxyLoginDiv').show();
                    }
                    if (key === 'scriptVersion') {
                        $('#scriptVer').text('v' + val);
                    }
                    if (key === 'loginComplete' && val === true) {
                        $('#loginInputDiv').hide();
                        $('#clearLoginDiv').show();
                    }
                });
                $.each(data.settings, function(key, val) {
                    var elem = document.getElementById(key);
                    if ($(elem)) {
                        $(elem).attr('value', val);
                        $(elem).focus();
                    }
                });
            });
        });

        $("#proxyLoginLink").click(function() {
            window.location.href = 'http://' + rootHost + ':' + configData.settings.proxyPort;
        });
        $("#clearLoginBtn").click(function() {
            let url = rootOrigin + '/clearAuth';
            $.getJSON(url, function(data) {
                if (data.result === 'Clear Complete') {
                    toastr.options = {
                        "closeButton": false,
                        "debug": false,
                        "newestOnTop": false,
                        "progressBar": false,
                        "positionClass": "toast-bottom-center",
                        "preventDuplicates": true,
                        "onclick": null,
                        "showDuration": 300,
                        "hideDuration": 1000,
                        "timeOut": 5000,
                        "extendedTimeOut": 1000,
                        "showEasing": "swing",
                        "hideEasing": "linear",
                        "showMethod": "fadeIn",
                        "hideMethod": "fadeOut"
                    }
                    toastr.success('Success!', "Authentication Cleared");
                    window.location.href = rootOrigin + '/config';
                }
            });
        });
        (function($) {
            $.fn.serializeFormJSON = function() {
                var o = {};
                var a = this.serializeArray();
                $.each(a, function() {
                    if (o[this.name]) {
                        if (!o[this.name].push) {
                            o[this.name] = [o[this.name]];
                        }
                        o[this.name].push(this.value || '');
                    } else {
                        o[this.name] = this.value || '';
                    }
                });
                return o;
            };
        })(jQuery);

        $('form').submit(function(e) {
            e.preventDefault();
            var config = $(this).serializeFormJSON();
            var url = rootOrigin + '/configData';
            if (Object.keys(config).length) {
                console.log(config);
                // $.post(url, {
                //     "clientId": "1",
                //     "sensor": "Temp",
                //     "dateStart": "2016-09-03 00:00:00",
                //     "dateEnd": "2016-09-03 00:59:59"
                // })
                var xmlhttp = new XMLHttpRequest();
                xmlhttp.open("POST", rootOrigin + '/configData');
                xmlhttp.onreadystatechange = function() {
                    if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
                        // console.log(xmlhttp.responseText);
                        // Command: toastr["success"]("Settings Saved", "Success")
                        toastr.options = {
                            "closeButton": false,
                            "debug": false,
                            "newestOnTop": false,
                            "progressBar": false,
                            "positionClass": "toast-bottom-center",
                            "preventDuplicates": true,
                            "onclick": null,
                            "showDuration": 300,
                            "hideDuration": 1000,
                            "timeOut": 5000,
                            "extendedTimeOut": 1000,
                            "showEasing": "swing",
                            "hideEasing": "linear",
                            "showMethod": "fadeIn",
                            "hideMethod": "fadeOut"
                        }
                        toastr.success('Success!', "Setting Saved..")
                    }
                }
                xmlhttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
                for (const h in config) {
                    xmlhttp.setRequestHeader(h.toString(), config[h].toString())
                }
                xmlhttp.send(JSON.stringify(config));

            }
        });
    </script>
</body>

</html>